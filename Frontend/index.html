<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Socket.IO Chat</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="app">
      <div id="connection-panel">
        <h1>Socket.IO Chat</h1>
        <div class="connection-options">
          <div class="host-form">
            <h3>Host a Chat Server</h3>
            <input
              type="number"
              id="port-input"
              placeholder="Port (default: 3000)"
              value="3000"
            />
            <button id="host-btn">Host Chat Server</button>
            <button id="stop-host-btn" disabled>Stop Hosting</button>
            <div id="host-status"></div>
          </div>

          <div class="divider">OR</div>

          <div class="connect-form">
            <h3>Connect to a Server</h3>
            <input
              type="text"
              id="server-address"
              placeholder="Server address (e.g., http://localhost:3000)"
            />
            <button id="connect-btn">Connect</button>
            <div id="connect-status"></div>
          </div>
        </div>
      </div>

      <div id="chat-panel" style="display: none">
        <div class="chat-header">
          <div class="connection-status">
            Status: <span id="status">Disconnected</span>
          </div>
          <button id="disconnect-btn">Disconnect</button>
        </div>

        <div class="username-form">
          <input
            type="text"
            id="username-input"
            placeholder="Enter your username"
          />
          <button id="set-username">Set Username</button>
        </div>

        <div id="messages"></div>

        <div class="message-input">
          <input
            type="text"
            id="message-input"
            placeholder="Type your message"
            disabled
          />
          <button id="send-btn" disabled>Send</button>
        </div>
      </div>
    </div>

    <script>
      const { ipcRenderer } = require("electron");

      const hostBtn = document.getElementById("host-btn");
      const stopHostBtn = document.getElementById("stop-host-btn");
      const connectBtn = document.getElementById("connect-btn");
      const disconnectBtn = document.getElementById("disconnect-btn");
      const portInput = document.getElementById("port-input");
      const serverAddressInput = document.getElementById("server-address");
      const hostStatus = document.getElementById("host-status");
      const connectStatus = document.getElementById("connect-status");
      const statusElement = document.getElementById("status");
      const usernameInput = document.getElementById("username-input");
      const setUsernameBtn = document.getElementById("set-username");
      const messageInput = document.getElementById("message-input");
      const sendBtn = document.getElementById("send-btn");
      const messagesDiv = document.getElementById("messages");
      const connectionPanel = document.getElementById("connection-panel");
      const chatPanel = document.getElementById("chat-panel");

      hostBtn.addEventListener("click", async () => {
        try {
          hostBtn.disabled = true;
          const port = portInput.value || 3000;
          const actualPort = await ipcRenderer.invoke(
            "host-server",
            parseInt(port)
          );

          hostStatus.textContent = `Server running on port ${actualPort}`;
          hostStatus.style.color = "green";
          stopHostBtn.disabled = false;

          await connectToServer(`http://localhost:${actualPort}`);
        } catch (error) {
          hostStatus.textContent = `Error: ${error.message}`;
          hostStatus.style.color = "red";
          console.error("Error hosting server:", error);
        } finally {
          hostBtn.disabled = false;
        }
      });

      stopHostBtn.addEventListener("click", async () => {
        try {
          stopHostBtn.disabled = true;
          await ipcRenderer.invoke("stop-server");
          hostStatus.textContent = "Server stopped";
          hostStatus.style.color = "black";
          stopHostBtn.disabled = true;
        } catch (error) {
          console.error("Error stopping server:", error);
        }
      });

      connectBtn.addEventListener("click", async () => {
        const address = serverAddressInput.value.trim();
        if (address) {
          await connectToServer(address);
        }
      });

      disconnectBtn.addEventListener("click", () => {
        ipcRenderer.send("connect-to-server", null);
        chatPanel.style.display = "none";
        connectionPanel.style.display = "block";
      });

      setUsernameBtn.addEventListener("click", () => {
        const username = usernameInput.value.trim();
        if (username) {
          ipcRenderer.send("set-username", username);
          usernameInput.disabled = true;
          setUsernameBtn.disabled = true;
          messageInput.disabled = false;
          sendBtn.disabled = false;
          messageInput.focus();
        }
      });

      sendBtn.addEventListener("click", sendMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          sendMessage();
        }
      });

      function sendMessage() {
        const message = messageInput.value.trim();
        if (message) {
          ipcRenderer.send("send-message", message);
          messageInput.value = "";
        }
      }

      async function connectToServer(address) {
        try {
          connectBtn.disabled = true;
          connectStatus.textContent = "Connecting...";
          connectStatus.style.color = "blue";

          ipcRenderer.send("connect-to-server", address);

          await new Promise((resolve, reject) => {
            const listener = (event, data) => {
              if (data.status === "connected") {
                ipcRenderer.off("connection-status", listener);
                connectStatus.textContent = "Connected successfully";
                connectStatus.style.color = "green";
                resolve();
              } else if (data.status === "error") {
                ipcRenderer.off("connection-status", listener);
                connectStatus.textContent = `Error: ${
                  data.error || "Connection failed"
                }`;
                connectStatus.style.color = "red";
                reject(new Error(data.error || "Connection failed"));
              }
            };
            ipcRenderer.on("connection-status", listener);
          });

          connectionPanel.style.display = "none";
          chatPanel.style.display = "block";
        } catch (error) {
          console.error("Connection error:", error);
        } finally {
          connectBtn.disabled = false;
        }
      }

      ipcRenderer.on("connection-status", (event, data) => {
        statusElement.textContent = data.status;
        if (data.status === "connected") {
          statusElement.style.color = "green";
        } else if (data.status === "disconnected") {
          statusElement.style.color = "red";
        } else {
          statusElement.style.color = "black";
        }
      });

      ipcRenderer.on("server-status", (event, data) => {
        if (data.status === "running") {
          hostStatus.textContent = `Server running on port ${data.port}`;
          hostStatus.style.color = "green";
        } else if (data.status === "stopped") {
          hostStatus.textContent = "Server stopped";
          hostStatus.style.color = "black";
        } else if (data.status === "error") {
          hostStatus.textContent = `Error: ${data.error}`;
          hostStatus.style.color = "red";
        }
      });

      ipcRenderer.on("new-message", (event, data) => {
        const messageElement = document.createElement("div");
        messageElement.className = "message";

        const userElement = document.createElement("span");
        userElement.className = "user";
        userElement.textContent = data.user + ": ";

        const textElement = document.createElement("span");
        textElement.className = "text";
        textElement.textContent = data.message;

        messageElement.appendChild(userElement);
        messageElement.appendChild(textElement);
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    </script>
  </body>
</html>
